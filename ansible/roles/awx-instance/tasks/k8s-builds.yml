#canary201026.0936

# Custom runner image with the `wp` command-line tool and a WordPress layout in /wp
- include_vars: ../../../vars/image-vars.yml
- include_vars: k8s-vars.yml

- name: "Pull {{ awx_runner_base_image_fullname }}"
  openshift_imagestream:
    metadata:
      name: "{{ awx_runner_base_image_name }}"
      namespace: "{{ ansible_oc_namespace }}"
    from: "{{ awx_runner_base_image_fullname }}"
    tag: latest

- name: "Build {{ awx_runner_image_name }} in OpenShift"
  register: _awx_runner_buildconfig
  openshift_imagestream:
    metadata:
      name: "{{ awx_runner_image_name }}"
      namespace: "{{ ansible_oc_namespace }}"
    dockerfile: "{{ lookup('template', 'Dockerfile.' + awx_runner_image_name) }}"

- name: "Rebuild {{ awx_runner_image_name }} now"
  when: _awx_runner_buildconfig is changed
  shell: "oc -n {{ awx_build_namespace }} start-build --wait {{ awx_runner_image_name }}"
  delegate_to: localhost

- name: "Patch {{ awx_task_base_image_fullname }} into {{ awx_task_image_name }}"
  register: _awx_task_buildconfig
  openshift_imagestream:
    tag: "{{ awx_version }}"
    metadata:
      name: "{{ awx_task_image_name }}"
      namespace: "{{ ansible_oc_namespace }}"
    dockerfile: |
      FROM {{ awx_task_base_image_fullname }}




      #zzz200716.1427
      # Modifie les autorisations pour le debug de python
      USER 0
      RUN id; chmod -R g+w /var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/ || true
      
      #zzz200716.1427
      RUN echo "chmod -R Python canary201026.0959" >> /canary.txt

      #zzz200716.1427
      # installation des packages manquants
      RUN yum -y install htop nano git
      
      #zzz200716.1427
      # Installation de la sonde Telegraf
      RUN git clone https://github.com/zuzu59/telegraf.git && \
      export dbflux_srv_host={{ lookup('env','dbflux_srv_host') }} && \
      export dbflux_srv_port={{ lookup('env','dbflux_srv_port') }} && \
      export dbflux_u_user={{ lookup('env','dbflux_u_user') }} && \
      export dbflux_p_user={{ lookup('env','dbflux_p_user') }} && \
      /home/awx/telegraf/install_docker_centos.sh || true

      #zzz200716.1427
      # Lance Telegraf au dÃ©marrage du container
      RUN sed -i '$ i\/home/awx/telegraf/start_docker.sh' /usr/bin/launch_awx.sh

      #zzz200716.1427
      RUN echo "telegraf install canary200723.1630" >> /canary.txt
      RUN echo "test canary rebuuild canary201026.1136" >> /canary.txt


      USER 1000
      #zzz200716.1427






      # https://github.com/ansible/awx/issues/6692#issuecomment-613451838
      USER 0
      RUN set -e -x; for playbook in /var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/playbooks/*_isolated.yml; do sed -i '/rsync_opts:/a \ \ \ \ \ \ \ \ \ \ -\ "--blocking-io"' $playbook; done
      USER 1000

- name: "Rebuild {{ awx_task_image_name }} now"
  when: _awx_task_buildconfig is changed
  shell: "oc -n {{ awx_build_namespace }} start-build --wait {{ awx_task_image_name }}"
  delegate_to: localhost